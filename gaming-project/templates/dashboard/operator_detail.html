{% extends 'base.html' %}
{% load static %}
{% load dashboard_filters %}

{% block title %}{{ operator.name }} - Operator Details{% endblock %}

{% block extra_css %}
<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
<style>
    .metric-card {
        transition: transform 0.2s;
    }
    .metric-card:hover {
        transform: translateY(-2px);
    }
    .chart-toggle-btn {
        cursor: pointer;
        transition: all 0.2s;
    }
    .chart-toggle-btn.active {
        background-color: #0d6efd !important;
        color: white !important;
    }
    .table-cell-flagged {
        background-color: #fff3cd !important;
        font-weight: bold;
    }
    
    /* DataTables styling to match theme */
    .dataTables_wrapper {
        font-family: inherit;
    }
    
    .dataTables_filter input {
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        padding: 0.5rem 0.75rem;
        font-size: 0.875rem;
        margin-left: 0.5rem;
    }
    
    .dataTables_filter input:focus {
        border-color: #0d6efd;
        outline: none;
        box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.1);
    }
    
    .dataTables_length select {
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        padding: 0.375rem 2rem 0.375rem 0.75rem;
        font-size: 0.875rem;
        margin: 0 0.5rem;
    }
    
    .dataTables_info {
        font-size: 0.875rem;
        color: #6b7280;
        padding-top: 1rem;
    }
    
    .dataTables_paginate {
        padding-top: 1rem;
    }
    
    .dataTables_paginate .paginate_button {
        padding: 0.375rem 0.75rem;
        margin: 0 0.125rem;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        background: white;
        color: #374151 !important;
        font-size: 0.875rem;
    }
    
    .dataTables_paginate .paginate_button:hover {
        background: #f9fafb !important;
        border-color: #d1d5db !important;
        color: #111827 !important;
    }
    
    .dataTables_wrapper .dataTables_paginate .paginate_button.current,
    .dataTables_wrapper .dataTables_paginate .paginate_button.current:active,
    .dataTables_wrapper .dataTables_paginate .paginate_button.current:focus,
    a.paginate_button.current {
        background: #0d6efd !important;
        background-color: #0d6efd !important;
        border-color: #0d6efd !important;
        color: #fff !important;
    }
    
    .dataTables_wrapper .dataTables_paginate .paginate_button.current:hover,
    a.paginate_button.current:hover {
        background: #0b5ed7 !important;
        background-color: #0b5ed7 !important;
        border-color: #0b5ed7 !important;
        color: #fff !important;
    }
    
    .dataTables_paginate .paginate_button.disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    #transactionsTable tbody tr {
        border-bottom: 1px solid #d1d5db;
    }
    
    #transactionsTable tbody td {
        padding: 12px 8px;
    }
    
    /* Prevent horizontal overflow from Bootstrap rows */
    .container-fluid > .row {
        margin-left: 0;
        margin-right: 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="py-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'operators_list' %}">Operators</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ operator.name }}</li>
        </ol>
    </nav>

    <!-- Header with operator info and actions -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="d-flex align-items-center">
            <div class="avatar rounded-circle bg-primary text-white d-flex align-items-center justify-content-center me-3" style="width: 48px; height: 48px;">
                <svg class="icon icon-sm" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
                </svg>
            </div>
            <div>
                <h2 class="h4 mb-0">{{ operator.name }}</h2>
                <p class="text-muted small mb-0">{{ operator.code }} - <span class="badge bg-secondary">{{ operator.tier }}</span></p>
            </div>
        </div>
        
        <div>
            <button class="btn btn-sm btn-outline-secondary me-2" onclick="window.print()">
                <svg class="icon icon-xs me-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v3a2 2 0 002 2h1v2a2 2 0 002 2h6a2 2 0 002-2v-2h1a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z" clip-rule="evenodd"></path>
                </svg>
                Print
            </button>
            <button class="btn btn-sm btn-primary">
                <svg class="icon icon-xs me-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                </svg>
                Export
            </button>
        </div>
    </div>

    <!-- Date Range Filter -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body py-3">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <div class="d-flex align-items-center">
                        <label class="me-2 mb-0 text-muted small fw-bold">Period:</label>
                        <select class="form-select form-select-sm w-auto me-2" id="filterSelect" onchange="applyFilter()">
                            <option value="all" {% if current_filter == 'all' %}selected{% endif %}>All Time</option>
                            <option value="today" {% if current_filter == 'today' %}selected{% endif %}>Today</option>
                            <option value="week" {% if current_filter == 'week' %}selected{% endif %}>This Week</option>
                            <option value="month" {% if current_filter == 'month' %}selected{% endif %}>This Month</option>
                            <option value="q1" {% if current_filter == 'q1' %}selected{% endif %}>Q1</option>
                            <option value="q2" {% if current_filter == 'q2' %}selected{% endif %}>Q2</option>
                            <option value="q3" {% if current_filter == 'q3' %}selected{% endif %}>Q3</option>
                            <option value="q4" {% if current_filter == 'q4' %}selected{% endif %}>Q4</option>
                        </select>
                        <span class="text-muted small">{{ filter_period }}</span>
                    </div>
                </div>
                <div class="col-md-4 text-end">
                    <span class="badge bg-warning">{{ total_anomalies }} Anomalies</span>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Chart Area -->
        <div class="col-12 col-lg-9 mb-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-0 fw-bold">Performance Over Time</h6>
                            <p class="text-muted small mb-0">{{ date_range_display }}</p>
                        </div>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-primary chart-toggle-btn active" data-metric="ggr">GGR</button>
                            <button type="button" class="btn btn-outline-primary chart-toggle-btn" data-metric="stakes">Stakes</button>
                            <button type="button" class="btn btn-outline-primary chart-toggle-btn" data-metric="payouts">Payouts</button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div id="performanceChart" style="height: 350px;"></div>
                </div>
            </div>
        </div>

        <!-- Metrics Sidebar -->
        <div class="col-12 col-lg-3 mb-4">
            <div class="card border-0 shadow-sm mb-3 metric-card">
                <div class="card-body">
                    <h6 class="text-muted mb-2 text-uppercase" style="font-size: 0.75rem; letter-spacing: 0.5px;">Total GGR</h6>
                    <h3 class="fw-bold mb-0 text-success">UGX {{ total_ggr|humanize_number }}</h3>
                    <div class="d-flex align-items-center mt-2">
                        <span class="badge bg-success-soft text-success">
                            <svg class="icon icon-xs me-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                <path fill-rule="evenodd" d="M12 7a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0V8.414l-4.293 4.293a1 1 0 01-1.414 0L8 10.414l-4.293 4.293a1 1 0 01-1.414-1.414l5-5a1 1 0 011.414 0L11 10.586 14.586 7H12z" clip-rule="evenodd"></path>
                            </svg>
                            +12.5%
                        </span>
                    </div>
                </div>
            </div>

            <div class="card border-0 shadow-sm mb-3 metric-card">
                <div class="card-body">
                    <h6 class="text-muted mb-2 text-uppercase" style="font-size: 0.75rem; letter-spacing: 0.5px;">Total Stakes</h6>
                    <h3 class="fw-bold mb-0 text-info">UGX {{ total_stakes|humanize_number }}</h3>
                </div>
            </div>

            <div class="card border-0 shadow-sm metric-card">
                <div class="card-body">
                    <h6 class="text-muted mb-2 text-uppercase" style="font-size: 0.75rem; letter-spacing: 0.5px;">Total Payouts</h6>
                    <h3 class="fw-bold mb-0 text-warning">UGX {{ total_payouts|humanize_number }}</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Transaction History & Anomaly Alerts -->
    <div class="row g-3">
        <!-- Transaction Table -->
        <div class="col-md-9">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-0 fw-bold">Transaction History</h6>
                            <p class="text-muted small mb-0">Recent transactions and flagged anomalies</p>
                        </div>
                        <div class="d-flex align-items-center">
                            <label class="me-2 mb-0 text-muted small">Filter:</label>
                            <select class="form-select form-select-sm w-auto" id="anomalyFilter">
                                <option value="all" selected>All Transactions</option>
                                <option value="anomalous">Anomalous Only</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <table class="table table-hover align-middle mb-0" id="transactionsTable">
                            <thead class="thead-light">
                                <tr>
                                    <th class="border-0">Date</th>
                                    <th class="border-0">Stakes (UGX)</th>
                                    <th class="border-0">Payouts (UGX)</th>
                                    <th class="border-0">GGR (UGX)</th>
                                    <th class="border-0">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for transaction in transactions %}
                                <tr data-anomaly-type="{{ transaction.anomaly_type }}" 
                                    {% if transaction.has_anomaly %}
                                    class="anomaly-row" style="cursor: pointer;"
                                    data-anomaly='{
                                        "date": "{{ transaction.date|date:"d/m/Y" }}",
                                        "operator": "{{ operator.name }}",
                                        "operator_tier": "{{ operator.tier }}",
                                        "game_type": "{{ transaction.game_type }}",
                                        "anomaly_type": "{{ transaction.anomaly_type }}",
                                        "stakes": {{ transaction.total_stake }},
                                        "stake_predicted": {{ transaction.stake_predicted }},
                                        "stake_deviation": {{ transaction.stake_deviation }},
                                        "stake_deviation_pct": {{ transaction.stake_deviation_pct }},
                                        "anomaly_score_stake": {{ transaction.anomaly_score_stake }},
                                        "payouts": {{ transaction.total_payout }},
                                        "payout_predicted": {{ transaction.payout_predicted }},
                                        "payout_deviation": {{ transaction.payout_deviation }},
                                        "payout_deviation_pct": {{ transaction.payout_deviation_pct }},
                                        "anomaly_score_payout": {{ transaction.anomaly_score_payout }},
                                        "rtp": {{ transaction.rtp }},
                                        "ggr": {{ transaction.ggr }},
                                        "dominant_stake_category": "{{ transaction.dominant_stake_category }}",
                                        "dominant_payout_category": "{{ transaction.dominant_payout_category }}",
                                        "top_games": "{{ transaction.top_games }}",
                                        "stake_flagged": {{ transaction.stake_flagged|lower }},
                                        "payout_flagged": {{ transaction.payout_flagged|lower }}
                                    }'
                                    {% endif %}>
                                    <td class="text-muted small">{{ transaction.date|date:"d/m/Y" }}</td>
                                    <td class="{% if transaction.stake_flagged %}table-cell-flagged{% endif %}" data-order="{{ transaction.total_stake }}">
                                        {{ transaction.total_stake|humanize_number }}
                                        {% if transaction.stake_flagged %}
                                            <svg class="icon icon-xs text-warning ms-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                            </svg>
                                        {% endif %}
                                    </td>
                                    <td class="{% if transaction.payout_flagged %}table-cell-flagged{% endif %}" data-order="{{ transaction.total_payout }}">
                                        {{ transaction.total_payout|humanize_number }}
                                        {% if transaction.payout_flagged %}
                                            <svg class="icon icon-xs text-danger ms-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                            </svg>
                                        {% endif %}
                                    </td>
                                    <td data-order="{{ transaction.ggr }}">{{ transaction.ggr|humanize_number }}</td>
                                    <td>
                                        {% if transaction.anomaly_type == 'Both' %}
                                            <span class="badge bg-danger">Both</span>
                                        {% elif transaction.anomaly_type == 'Stake Only' %}
                                            <span class="badge bg-warning text-dark">Stake</span>
                                        {% elif transaction.anomaly_type == 'Payout Only' %}
                                            <span class="badge bg-warning text-dark">Payout</span>
                                        {% else %}
                                            <span class="badge bg-success">Normal</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                </div>
            </div>
        </div>

        <!-- Anomaly Notifications -->
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom py-3">
                    <div class="d-flex align-items-center">
                        <svg class="icon icon-sm text-warning me-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                        </svg>
                        <h6 class="mb-0 fw-bold">Recent Anomalies</h6>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% for record in anomaly_records %}
                            <div class="list-group-item border-0 py-3">
                                <div class="d-flex align-items-start">
                                    <div class="flex-shrink-0">
                                        {% if record.anomaly_type == 'Both' %}
                                        <span class="badge bg-danger">Both</span>
                                        {% elif record.anomaly_type == 'Stake Only' %}
                                        <span class="badge bg-warning text-dark">Stake</span>
                                        {% elif record.anomaly_type == 'Payout Only' %}
                                        <span class="badge bg-warning text-dark">Payout</span>
                                        {% endif %}
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <p class="mb-1 fw-bold small">{{ record.date|date:"d M Y" }}</p>
                                                <p class="mb-0 text-muted" style="font-size: 0.75rem;">
                                                    {% if record.stake_flagged %}
                                                    Stake: UGX {{ record.total_stake|humanize_number }}
                                                    {% if record.stake_deviation_pct %}
                                                    ({{ record.stake_deviation_pct|floatformat:1 }}%)
                                                    {% endif %}
                                                    <br>
                                                    {% endif %}
                                                    {% if record.payout_flagged %}
                                                    Payout: UGX {{ record.total_payout|humanize_number }}
                                                    {% if record.payout_deviation_pct %}
                                                    ({{ record.payout_deviation_pct|floatformat:1 }}%)
                                                    {% endif %}
                                                    {% endif %}
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% empty %}
                            <div class="list-group-item border-0 py-3 text-center text-muted">
                                No anomalies detected
                            </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="card-footer bg-white border-top py-2 text-center">
                    <a href="#" class="text-decoration-none small fw-bold text-primary">View All Anomalies â†’</a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Anomaly Detail Modal -->
<div class="modal fade" id="anomalyDetailModal" tabindex="-1" aria-labelledby="anomalyDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <div class="w-100">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h5 class="modal-title fw-bold" id="anomalyDetailModalLabel">Anomaly Detail</h5>
                            <p class="text-muted small mb-0" id="modal-date"></p>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                </div>
            </div>
            <div class="modal-body pt-2">
                <!-- Operator Info -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <small class="text-muted d-block">Operator</small>
                        <p class="mb-0 fw-bold" id="modal-operator"></p>
                    </div>
                    <div class="col-md-6">
                        <small class="text-muted d-block">Tier</small>
                        <p class="mb-0" id="modal-tier"></p>
                    </div>
                </div>

                <!-- Game Info -->
                <div class="mb-3 p-3 bg-light rounded">
                    <h6 class="text-muted text-uppercase mb-2" style="font-size: 0.75rem;">
                        <svg class="icon icon-xs me-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                            <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                            <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                        </svg>
                        Game Information
                    </h6>
                    <div class="row">
                        <div class="col-md-4">
                            <small class="text-muted d-block">Game Type</small>
                            <p class="mb-0" id="modal-game-type"></p>
                        </div>
                        <div class="col-md-4">
                            <small class="text-muted d-block">Stake Category</small>
                            <p class="mb-0" id="modal-stake-category"></p>
                        </div>
                        <div class="col-md-4">
                            <small class="text-muted d-block">Payout Category</small>
                            <p class="mb-0" id="modal-payout-category"></p>
                        </div>
                    </div>
                    <div class="mt-2" id="modal-top-games-container" style="display: none;">
                        <small class="text-muted d-block">Top Games</small>
                        <p class="mb-0" id="modal-top-games"></p>
                    </div>
                </div>

                <!-- Stake Analysis -->
                <div class="mb-4" id="stake-analysis">
                    <h6 class="text-muted text-uppercase mb-3" style="font-size: 0.75rem;">
                        <svg class="icon icon-xs text-warning me-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                        </svg>
                        Stake Analysis
                    </h6>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card bg-light border-0 mb-2">
                                <div class="card-body py-2">
                                    <small class="text-muted d-block">Actual Stake</small>
                                    <p class="fw-bold mb-0" id="modal-stake-actual"></p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light border-0 mb-2">
                                <div class="card-body py-2">
                                    <small class="text-muted d-block">Expected Stake</small>
                                    <p class="mb-0" id="modal-stake-predicted"></p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border-0 mb-2" id="stake-deviation-card">
                                <div class="card-body py-2">
                                    <small class="d-block" id="stake-deviation-label">Deviation</small>
                                    <p class="fw-bold mb-0" id="modal-stake-deviation"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted">Anomaly Score: <span id="modal-stake-score" class="fw-bold"></span></small>
                    </div>
                </div>

                <!-- Payout Analysis -->
                <div class="mb-4" id="payout-analysis">
                    <h6 class="text-muted text-uppercase mb-3" style="font-size: 0.75rem;">
                        <svg class="icon icon-xs text-danger me-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                        </svg>
                        Payout Analysis
                    </h6>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card bg-light border-0 mb-2">
                                <div class="card-body py-2">
                                    <small class="text-muted d-block">Actual Payout</small>
                                    <p class="fw-bold mb-0" id="modal-payout-actual"></p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light border-0 mb-2">
                                <div class="card-body py-2">
                                    <small class="text-muted d-block">Expected Payout</small>
                                    <p class="mb-0" id="modal-payout-predicted"></p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border-0 mb-2" id="payout-deviation-card">
                                <div class="card-body py-2">
                                    <small class="d-block" id="payout-deviation-label">Deviation</small>
                                    <p class="fw-bold mb-0" id="modal-payout-deviation"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted">Anomaly Score: <span id="modal-payout-score" class="fw-bold"></span></small>
                    </div>
                </div>

                <!-- Key Metrics -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="card bg-light border-0">
                            <div class="card-body py-2">
                                <small class="text-muted d-block">RTP (Return to Player)</small>
                                <p class="fw-bold mb-0" id="modal-rtp"></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card bg-light border-0">
                            <div class="card-body py-2">
                                <small class="text-muted d-block">GGR (Gross Gaming Revenue)</small>
                                <p class="fw-bold mb-0" id="modal-ggr"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- ApexCharts -->
<script src="https://cdn.jsdelivr.net/npm/apexcharts@3.45.1/dist/apexcharts.min.js"></script>
<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>

<script>
    // Parse chart data
    const chartData = {
        ggr: {{ chart_data.ggr|safe }},
        stakes: {{ chart_data.stakes|safe }},
        payouts: {{ chart_data.payouts|safe }},
        dates: {{ chart_data.dates|safe }}
    };

    let chart = null;
    let transactionsTable = null;

    function updateChart(metric) {
        // Destroy existing chart
        if (chart) {
            chart.destroy();
        }

        // Define color based on metric
        const colors = {
            'ggr': '#198754',
            'stakes': '#0dcaf0',
            'payouts': '#ffc107'
        };

        // Chart options
        const options = {
            series: [{
                name: metric.toUpperCase() + ' (UGX)',
                data: chartData[metric]
            }],
            chart: {
                type: 'area',
                height: 350,
                fontFamily: 'inherit',
                toolbar: {
                    show: true,
                    tools: {
                        download: true,
                        selection: true,
                        zoom: true,
                        zoomin: true,
                        zoomout: true,
                        pan: true,
                        reset: true
                    }
                },
                zoom: {
                    enabled: true
                }
            },
            colors: [colors[metric]],
            dataLabels: {
                enabled: false
            },
            stroke: {
                curve: 'smooth',
                width: 3
            },
            fill: {
                type: 'gradient',
                gradient: {
                    shadeIntensity: 1,
                    opacityFrom: 0.6,
                    opacityTo: 0.1,
                    stops: [0, 90, 100]
                }
            },
            xaxis: {
                categories: chartData.dates,
                labels: {
                    rotate: -45,
                    rotateAlways: false,
                    hideOverlappingLabels: true,
                    trim: true,
                    style: {
                        fontSize: '11px'
                    }
                },
                tickAmount: 20,
                tickPlacement: 'on',
                axisBorder: {
                    show: true
                },
                axisTicks: {
                    show: true
                }
            },
            yaxis: {
                labels: {
                    formatter: function(val) {
                        if (val >= 1000000) {
                            return 'UGX ' + (val / 1000000).toFixed(1) + 'M';
                        } else if (val >= 1000) {
                            return 'UGX ' + (val / 1000).toFixed(1) + 'K';
                        }
                        return 'UGX ' + val.toFixed(0);
                    }
                }
            },
            grid: {
                borderColor: '#e7e7e7',
                strokeDashArray: 3
            },
            tooltip: {
                theme: 'light',
                y: {
                    formatter: function(val) {
                        return 'UGX ' + val.toLocaleString();
                    }
                }
            },
            markers: {
                size: 0,
                hover: {
                    size: 5
                }
            }
        };

        // Render chart
        chart = new ApexCharts(document.querySelector("#performanceChart"), options);
        chart.render();
    }

    // Initialize chart after DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize with GGR
        updateChart('ggr');

        // Chart Toggle buttons
        document.querySelectorAll('.chart-toggle-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.chart-toggle-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                updateChart(this.dataset.metric);
            });
        });

        // Initialize DataTables
        transactionsTable = $('#transactionsTable').DataTable({
            pageLength: 10,
            order: [[0, 'desc']], // Sort by date descending
            columnDefs: [],
            responsive: true,
            language: {
                search: "Search transactions:",
                lengthMenu: "Show _MENU_ transactions per page",
                info: "Showing _START_ to _END_ of _TOTAL_ transactions",
                infoEmpty: "No transactions available",
                infoFiltered: "(filtered from _MAX_ total transactions)",
                paginate: {
                    first: "First",
                    last: "Last",
                    next: "Next",
                    previous: "Previous"
                }
            },
            dom: "<'row'<'col-sm-12 col-md-6'l><'col-sm-12 col-md-6'f>>" +
                 "<'row'<'col-sm-12'tr>>" +
                 "<'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>"
        });

        // Anomaly Filter - integrate with DataTables search
        let anomalyFilterFunction = null;
        
        $('#anomalyFilter').on('change', function() {
            const filter = this.value;
            
            // Remove existing filter if any
            if (anomalyFilterFunction !== null) {
                const index = $.fn.dataTable.ext.search.indexOf(anomalyFilterFunction);
                if (index > -1) {
                    $.fn.dataTable.ext.search.splice(index, 1);
                }
                anomalyFilterFunction = null;
            }
            
            if (filter === 'anomalous') {
                // Add custom search function for anomalous only
                anomalyFilterFunction = function(settings, data, dataIndex) {
                    const row = transactionsTable.row(dataIndex).node();
                    const anomalyType = $(row).data('anomaly-type');
                    return anomalyType !== 'Normal';
                };
                $.fn.dataTable.ext.search.push(anomalyFilterFunction);
            }
            
            transactionsTable.draw();
        });

        // Anomaly row click handler
        $('#transactionsTable tbody').on('click', 'tr.anomaly-row', function(e) {
            const anomalyData = $(this).data('anomaly');
            if (anomalyData) {
                showAnomalyDetail(anomalyData);
            }
        });
    });

    // Humanize number function
    function humanizeNumber(value) {
        const absValue = Math.abs(value);
        if (absValue >= 1e12) {
            return (value / 1e12).toFixed(2) + 'T';
        } else if (absValue >= 1e9) {
            return (value / 1e9).toFixed(2) + 'B';
        } else if (absValue >= 1e6) {
            return (value / 1e6).toFixed(2) + 'M';
        } else if (absValue >= 1e3) {
            return (value / 1e3).toFixed(2) + 'K';
        }
        return value.toFixed(2);
    }

    function showAnomalyDetail(data) {
        // Populate basic info
        $('#modal-date').text(data.date);
        $('#modal-operator').text(data.operator);
        $('#modal-tier').text(data.operator_tier);
        $('#modal-game-type').text(data.game_type);
        $('#modal-stake-category').text(data.dominant_stake_category);
        $('#modal-payout-category').text(data.dominant_payout_category);
        
        // Show/hide top games
        if (data.top_games && data.top_games !== 'N/A' && data.top_games !== '') {
            $('#modal-top-games').text(data.top_games);
            $('#modal-top-games-container').show();
        } else {
            $('#modal-top-games-container').hide();
        }

        // Stake Analysis - Always show
        $('#modal-stake-actual').text('UGX ' + humanizeNumber(data.stakes));
        $('#modal-stake-predicted').text('UGX ' + humanizeNumber(data.stake_predicted));
        
        const stakeMultiplier = Math.abs(data.stake_deviation_pct) / 100;
        $('#modal-stake-deviation').text('UGX ' + humanizeNumber(Math.abs(data.stake_deviation)) + ' - ' + stakeMultiplier.toFixed(1) + 'x');
        $('#modal-stake-score').text(data.anomaly_score_stake.toFixed(2));
        
        // Apply styling based on stake flagged status
        const stakeCard = $('#stake-deviation-card');
        const stakeLabel = $('#stake-deviation-label');
        if (data.stake_flagged) {
            // Determine severity color based on score
            let bgColor, textColor;
            if (data.anomaly_score_stake >= 4) {
                bgColor = '#dc3545'; // red
                textColor = 'white';
            } else if (data.anomaly_score_stake >= 3) {
                bgColor = '#ffc107'; // yellow
                textColor = 'white';
            } else {
                bgColor = '#17a2b8'; // blue
                textColor = 'white';
            }
            stakeCard.css({'background-color': bgColor, 'color': textColor});
            stakeLabel.css('color', textColor);
        } else {
            stakeCard.css({'background-color': '#f8f9fa', 'color': '#6c757d'});
            stakeLabel.css('color', '#6c757d');
        }

        // Payout Analysis - Always show
        $('#modal-payout-actual').text('UGX ' + humanizeNumber(data.payouts));
        $('#modal-payout-predicted').text('UGX ' + humanizeNumber(data.payout_predicted));
        
        const payoutMultiplier = Math.abs(data.payout_deviation_pct) / 100;
        $('#modal-payout-deviation').text('UGX ' + humanizeNumber(Math.abs(data.payout_deviation)) + ' - ' + payoutMultiplier.toFixed(1) + 'x');
        $('#modal-payout-score').text(data.anomaly_score_payout.toFixed(2));
        
        // Apply styling based on payout flagged status
        const payoutCard = $('#payout-deviation-card');
        const payoutLabel = $('#payout-deviation-label');
        if (data.payout_flagged) {
            // Determine severity color based on score
            let bgColor, textColor;
            if (data.anomaly_score_payout >= 4) {
                bgColor = '#dc3545'; // red
                textColor = 'white';
            } else if (data.anomaly_score_payout >= 3) {
                bgColor = '#ffc107'; // yellow
                textColor = 'white';
            } else {
                bgColor = '#17a2b8'; // blue
                textColor = 'white';
            }
            payoutCard.css({'background-color': bgColor, 'color': textColor});
            payoutLabel.css('color', textColor);
        } else {
            payoutCard.css({'background-color': '#f8f9fa', 'color': '#6c757d'});
            payoutLabel.css('color', '#6c757d');
        }

        // Key Metrics
        $('#modal-rtp').text(data.rtp.toFixed(2) + '%');
        $('#modal-ggr').text('UGX ' + humanizeNumber(data.ggr));

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('anomalyDetailModal'));
        modal.show();
    }

    function viewTransactionDetail(id) {
        // Implement transaction detail view
        alert('View transaction detail: ' + id);
    }

    function applyFilter() {
        const filter = document.getElementById('filterSelect').value;
        const url = new URL(window.location.href);
        url.searchParams.set('filter', filter);
        window.location.href = url.toString();
    }
</script>
{% endblock %}

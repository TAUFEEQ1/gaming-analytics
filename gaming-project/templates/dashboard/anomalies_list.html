{% extends 'base.html' %}
{% load static %}
{% load dashboard_filters %}

{% block title %}Anomalies - Regulatory Triage{% endblock %}

{% block extra_css %}
<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
<style>
    /* Table styling */
    #anomaliesTable tbody tr {
        border-bottom: 1px solid #d1d5db !important;
    }
    #anomaliesTable thead th {
        border-bottom: 1px solid #d1d5db !important;
        padding: 12px 8px !important;
    }
    #anomaliesTable tbody td {
        padding: 12px 8px !important;
    }
    .table-flush tbody tr:last-child {
        border-bottom: 0 !important;
    }
    
    .table-cell-flagged {
        background-color: #fff3cd !important;
        font-weight: bold;
    }
    
    /* DataTables wrapper styling */
    .dataTables_wrapper {
        font-family: inherit;
    }
    
    /* Search input */
    .dataTables_filter input {
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        padding: 0.5rem 0.75rem;
        font-size: 0.875rem;
        margin-left: 0.5rem;
    }
    
    .dataTables_filter input:focus {
        border-color: #0d6efd;
        outline: none;
        box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.1);
    }
    
    .dataTables_filter label {
        font-weight: 500;
        color: #374151;
        font-size: 0.875rem;
    }
    
    /* Length selector */
    .dataTables_length select {
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        padding: 0.375rem 2rem 0.375rem 0.75rem;
        font-size: 0.875rem;
        margin: 0 0.5rem;
    }
    
    .dataTables_length label {
        font-weight: 500;
        color: #374151;
        font-size: 0.875rem;
    }
    
    /* Info text */
    .dataTables_info {
        font-size: 0.875rem;
        color: #6b7280;
        padding-top: 1rem;
    }
    
    /* Pagination */
    .dataTables_paginate {
        padding-top: 1rem;
    }
    
    .dataTables_paginate .paginate_button {
        padding: 0.375rem 0.75rem;
        margin: 0 0.125rem;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        background: white;
        color: #374151 !important;
        font-size: 0.875rem;
        font-weight: 500;
    }
    
    .dataTables_paginate .paginate_button:hover {
        background: #f9fafb !important;
        border-color: #d1d5db !important;
        color: #111827 !important;
    }
    
    .dataTables_wrapper .dataTables_paginate .paginate_button.current,
    .dataTables_wrapper .dataTables_paginate .paginate_button.current:active,
    .dataTables_wrapper .dataTables_paginate .paginate_button.current:focus,
    a.paginate_button.current {
        background: #0d6efd !important;
        background-color: #0d6efd !important;
        border-color: #0d6efd !important;
        color: #fff !important;
    }
    
    .dataTables_wrapper .dataTables_paginate .paginate_button.current:hover,
    a.paginate_button.current:hover {
        background: #0b5ed7 !important;
        background-color: #0b5ed7 !important;
        border-color: #0b5ed7 !important;
        color: #fff !important;
    }
    
    .dataTables_paginate .paginate_button.disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
</style>
{% endblock %}

{% block content %}
<div class="py-4">
    <div class="d-flex justify-content-between w-100 flex-wrap">
        <div class="mb-3 mb-lg-0">
            <h1 class="h4">Anomalies</h1>
            <p class="mb-0">Monitor and review flagged transactions across all operators.</p>
        </div>
        <div>
            <button class="btn btn-sm btn-outline-secondary me-2">
                <svg class="icon icon-xs me-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                </svg>
                Export
            </button>
            <button class="btn btn-sm btn-outline-secondary">
                <svg class="icon icon-xs me-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v3a2 2 0 002 2h1v2a2 2 0 002 2h6a2 2 0 002-2v-2h1a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z" clip-rule="evenodd"></path>
                </svg>
                Print
            </button>
        </div>
    </div>

    <div class="row g-3 mt-2">
        <!-- Anomalies Table -->
        <div class="col-lg-9">
            <!-- Operator Filter -->
            <div class="card border-0 shadow-sm mb-3">
                <div class="card-body py-3">
                    <form method="get" class="d-flex align-items-center">
                        <label class="me-2 mb-0 text-muted small fw-bold">Filter by Operator:</label>
                        <select name="operator" class="form-select form-select-sm w-auto me-2" onchange="this.form.submit()">
                            <option value="all" {% if selected_operator == 'all' %}selected{% endif %}>All Operators</option>
                            {% for operator in operators %}
                            <option value="{{ operator.code }}" {% if selected_operator == operator.code %}selected{% endif %}>
                                {{ operator.name }}
                            </option>
                            {% endfor %}
                        </select>
                        {% if selected_operator != 'all' %}
                        <a href="{% url 'anomalies_list' %}" class="btn btn-sm btn-outline-secondary">
                            Clear Filter
                        </a>
                        {% endif %}
                    </form>
                </div>
            </div>

            <!-- Anomalies Table Card -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Flagged Transactions</h5>
                        <span class="badge bg-warning text-dark">{{ total_anomalies }} Total</span>
                    </div>
                </div>
                <div class="card-body">
                    <table class="table table-hover table-flush align-middle mb-0" id="anomaliesTable">
                        <thead class="thead-light">
                            <tr>
                                <th class="border-0">Date</th>
                                <th class="border-0">Operator</th>
                                <th class="border-0">Game Type</th>
                                <th class="border-0">Stakes (UGX)</th>
                                <th class="border-0">Payouts (UGX)</th>
                                <th class="border-0">RTP %</th>
                                <th class="border-0">Type</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for anomaly in anomalies %}
                            <tr class="anomaly-row" style="cursor: pointer;"
                                data-anomaly='{
                                    "date": "{{ anomaly.date|date:"d/m/Y H:i" }}",
                                    "operator": "{{ anomaly.operator_name }}",
                                    "operator_tier": "{{ anomaly.operator_tier }}",
                                    "game_type": "{{ anomaly.game_type }}",
                                    "anomaly_type": "{{ anomaly.anomaly_type }}",
                                    "stakes": {{ anomaly.stakes }},
                                    "stake_predicted": {{ anomaly.stake_predicted }},
                                    "stake_deviation": {{ anomaly.stake_deviation }},
                                    "stake_deviation_pct": {{ anomaly.stake_deviation_pct }},
                                    "anomaly_score_stake": {{ anomaly.anomaly_score_stake }},
                                    "payouts": {{ anomaly.payouts }},
                                    "payout_predicted": {{ anomaly.payout_predicted }},
                                    "payout_deviation": {{ anomaly.payout_deviation }},
                                    "payout_deviation_pct": {{ anomaly.payout_deviation_pct }},
                                    "anomaly_score_payout": {{ anomaly.anomaly_score_payout }},
                                    "rtp": {{ anomaly.rtp }},
                                    "ggr": {{ anomaly.ggr }},
                                    "dominant_stake_category": "{{ anomaly.dominant_stake_category }}",
                                    "dominant_payout_category": "{{ anomaly.dominant_payout_category }}",
                                    "top_games": "{{ anomaly.top_games }}",
                                    "stake_flagged": {{ anomaly.stake_flagged|lower }},
                                    "payout_flagged": {{ anomaly.payout_flagged|lower }}
                                }'>
                                <td class="text-muted small">{{ anomaly.date|date:"d/m/Y H:i" }}</td>
                                <td class="fw-bold">
                                    <a href="{% url 'performance_detail' anomaly.operator_code %}" class="text-decoration-none">
                                        {{ anomaly.operator_name }}
                                    </a>
                                </td>
                                <td>{{ anomaly.game_type }}</td>
                                <td class="{% if anomaly.stake_flagged %}table-cell-flagged{% endif %}">
                                    {{ anomaly.stakes|floatformat:0 }}
                                    {% if anomaly.stake_flagged %}
                                    <svg class="icon icon-xs text-warning ms-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                    </svg>
                                    {% endif %}
                                </td>
                                <td class="{% if anomaly.payout_flagged %}table-cell-flagged{% endif %}">
                                    {{ anomaly.payouts|floatformat:0 }}
                                    {% if anomaly.payout_flagged %}
                                    <svg class="icon icon-xs text-danger ms-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                    </svg>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="{% if anomaly.rtp > 98 %}text-danger fw-bold{% endif %}">
                                        {{ anomaly.rtp|floatformat:2 }}%
                                    </span>
                                </td>
                                <td>
                                    {% if anomaly.stake_flagged %}
                                    <span class="badge bg-warning text-dark">High Stake</span>
                                    {% else %}
                                    <span class="badge bg-danger">High Payout</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Sidebar with Summary Cards -->
        <div class="col-lg-3">
            <!-- Stake Anomalies Card -->
            <div class="card border-0 shadow-sm mb-3">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="icon-shape icon-md bg-warning text-white rounded me-3">
                            <svg class="icon icon-sm" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                        <div>
                            <h6 class="text-muted mb-0" style="font-size: 0.75rem;">Stake Anomalies</h6>
                            <h3 class="fw-bold mb-0">{{ stake_anomalies }}</h3>
                        </div>
                    </div>
                    <div class="progress mb-2" style="height: 8px;">
                        <div class="progress-bar bg-warning" role="progressbar" 
                             style="width: {% widthratio stake_anomalies total_anomalies 100 %}%;" 
                             aria-valuenow="{{ stake_anomalies }}" 
                             aria-valuemin="0" 
                             aria-valuemax="{{ total_anomalies }}"></div>
                    </div>
                    <p class="text-muted small mb-0">
                        Avg: UGX {{ avg_stake_anomaly|humanize_number }}
                    </p>
                </div>
            </div>

            <!-- Payout Anomalies Card -->
            <div class="card border-0 shadow-sm mb-3">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="icon-shape icon-md bg-danger text-white rounded me-3">
                            <svg class="icon icon-sm" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                        <div>
                            <h6 class="text-muted mb-0" style="font-size: 0.75rem;">Payout Anomalies</h6>
                            <h3 class="fw-bold mb-0">{{ payout_anomalies }}</h3>
                        </div>
                    </div>
                    <div class="progress mb-2" style="height: 8px;">
                        <div class="progress-bar bg-danger" role="progressbar" 
                             style="width: {% widthratio payout_anomalies total_anomalies 100 %}%;" 
                             aria-valuenow="{{ payout_anomalies }}" 
                             aria-valuemin="0" 
                             aria-valuemax="{{ total_anomalies }}"></div>
                    </div>
                    <p class="text-muted small mb-0">
                        Avg: UGX {{ avg_payout_anomaly|humanize_number }}
                    </p>
                </div>
            </div>

            <!-- Total Anomalies Card -->
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h6 class="text-muted text-uppercase mb-2" style="font-size: 0.75rem; letter-spacing: 0.5px;">Total Anomalies</h6>
                    <h3 class="fw-bold mb-3">{{ total_anomalies }}</h3>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-muted small">Stake Issues</span>
                        <span class="fw-bold text-warning">{{ stake_anomalies }}</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="text-muted small">Payout Issues</span>
                        <span class="fw-bold text-danger">{{ payout_anomalies }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Anomaly Details Modal -->
<div class="modal fade" id="anomalyModal" tabindex="-1" aria-labelledby="anomalyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="anomalyModalLabel">Anomaly Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Operator & Date Info -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h6 class="text-muted text-uppercase mb-2" style="font-size: 0.75rem;">Operator</h6>
                        <p class="fw-bold mb-0" id="modal-operator"></p>
                        <small class="text-muted" id="modal-tier"></small>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-muted text-uppercase mb-2" style="font-size: 0.75rem;">Date</h6>
                        <p class="mb-0" id="modal-date"></p>
                    </div>
                </div>

                <!-- Anomaly Type Badge -->
                <div class="mb-4">
                    <h6 class="text-muted text-uppercase mb-2" style="font-size: 0.75rem;">Anomaly Classification</h6>
                    <span class="badge bg-primary" id="modal-anomaly-type"></span>
                </div>

                <!-- Game Information -->
                <div class="mb-4">
                    <h6 class="text-muted text-uppercase mb-2" style="font-size: 0.75rem;">Game Information</h6>
                    <div class="row">
                        <div class="col-md-4">
                            <small class="text-muted d-block">Game Type</small>
                            <p class="mb-0" id="modal-game-type"></p>
                        </div>
                        <div class="col-md-4">
                            <small class="text-muted d-block">Stake Category</small>
                            <p class="mb-0" id="modal-stake-category"></p>
                        </div>
                        <div class="col-md-4">
                            <small class="text-muted d-block">Payout Category</small>
                            <p class="mb-0" id="modal-payout-category"></p>
                        </div>
                    </div>
                    <div class="mt-2" id="modal-top-games-container" style="display: none;">
                        <small class="text-muted d-block">Top Games</small>
                        <p class="mb-0" id="modal-top-games"></p>
                    </div>
                </div>

                <!-- Stake Analysis -->
                <div class="mb-4" id="stake-analysis">
                    <h6 class="text-muted text-uppercase mb-3" style="font-size: 0.75rem;">
                        <svg class="icon icon-xs text-warning me-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                        </svg>
                        Stake Analysis
                    </h6>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card bg-light border-0 mb-2">
                                <div class="card-body py-2">
                                    <small class="text-muted d-block">Actual Stake</small>
                                    <p class="fw-bold mb-0" id="modal-stake-actual"></p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light border-0 mb-2">
                                <div class="card-body py-2">
                                    <small class="text-muted d-block">Expected Stake</small>
                                    <p class="mb-0" id="modal-stake-predicted"></p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border-0 mb-2" id="stake-deviation-card">
                                <div class="card-body py-2">
                                    <small class="text-muted d-block">Deviation</small>
                                    <p class="fw-bold mb-0" id="modal-stake-deviation"></p>
                                    <small class="text-muted" id="modal-stake-deviation-pct"></small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted">Anomaly Score: <span id="modal-stake-score" class="fw-bold"></span></small>
                    </div>
                </div>

                <!-- Payout Analysis -->
                <div class="mb-4" id="payout-analysis">
                    <h6 class="text-muted text-uppercase mb-3" style="font-size: 0.75rem;">
                        <svg class="icon icon-xs text-danger me-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                        </svg>
                        Payout Analysis
                    </h6>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card bg-light border-0 mb-2">
                                <div class="card-body py-2">
                                    <small class="text-muted d-block">Actual Payout</small>
                                    <p class="fw-bold mb-0" id="modal-payout-actual"></p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light border-0 mb-2">
                                <div class="card-body py-2">
                                    <small class="text-muted d-block">Expected Payout</small>
                                    <p class="mb-0" id="modal-payout-predicted"></p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border-0 mb-2" id="payout-deviation-card">
                                <div class="card-body py-2">
                                    <small class="text-muted d-block">Deviation</small>
                                    <p class="fw-bold mb-0" id="modal-payout-deviation"></p>
                                    <small class="text-muted" id="modal-payout-deviation-pct"></small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted">Anomaly Score: <span id="modal-payout-score" class="fw-bold"></span></small>
                    </div>
                </div>

                <!-- Key Metrics -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="card bg-light border-0">
                            <div class="card-body py-2">
                                <small class="text-muted d-block">RTP (Return to Player)</small>
                                <p class="fw-bold mb-0" id="modal-rtp"></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card bg-light border-0">
                            <div class="card-body py-2">
                                <small class="text-muted d-block">GGR (Gross Gaming Revenue)</small>
                                <p class="fw-bold mb-0" id="modal-ggr"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>

<script>
$(document).ready(function() {
    $('#anomaliesTable').DataTable({
        pageLength: 10,
        order: [[0, 'desc']], // Sort by date descending
        language: {
            search: "Search anomalies:",
            lengthMenu: "Show _MENU_ anomalies per page",
            info: "Showing _START_ to _END_ of _TOTAL_ anomalies",
            infoEmpty: "No anomalies found",
            infoFiltered: "(filtered from _MAX_ total anomalies)",
            paginate: {
                first: "First",
                last: "Last",
                next: "Next",
                previous: "Previous"
            }
        },
        dom: "<'row'<'col-sm-12 col-md-6'l><'col-sm-12 col-md-6'f>>" +
             "<'row'<'col-sm-12'tr>>" +
             "<'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>"
    });

    // Handle anomaly row clicks
    $('#anomaliesTable').on('click', '.anomaly-row', function(e) {
        // Don't open modal if clicking on the operator link
        if ($(e.target).closest('a').length) {
            return;
        }

        const anomalyData = JSON.parse($(this).attr('data-anomaly'));
        
        // Helper function to format numbers
        function formatNumber(num) {
            return new Intl.NumberFormat('en-US', { 
                minimumFractionDigits: 0, 
                maximumFractionDigits: 0 
            }).format(num);
        }

        function formatCurrency(num) {
            return 'UGX ' + formatNumber(num);
        }

        function getSeverityColor(devPct) {
            const absDev = Math.abs(devPct);
            if (absDev >= 100) return 'bg-danger';
            if (absDev >= 50) return 'bg-warning';
            if (absDev >= 20) return 'bg-info';
            return 'bg-light';
        }

        // Populate modal fields
        $('#modal-operator').text(anomalyData.operator);
        $('#modal-tier').text(anomalyData.operator_tier);
        $('#modal-date').text(anomalyData.date);
        $('#modal-game-type').text(anomalyData.game_type);
        $('#modal-anomaly-type').text(anomalyData.anomaly_type)
            .removeClass('bg-primary bg-warning bg-danger')
            .addClass(anomalyData.anomaly_type === 'Both' ? 'bg-danger' : 
                     anomalyData.anomaly_type === 'Stake Only' ? 'bg-warning' : 'bg-primary');

        // Game information
        $('#modal-stake-category').text(anomalyData.dominant_stake_category || 'N/A');
        $('#modal-payout-category').text(anomalyData.dominant_payout_category || 'N/A');
        
        if (anomalyData.top_games && anomalyData.top_games.trim()) {
            $('#modal-top-games').text(anomalyData.top_games);
            $('#modal-top-games-container').show();
        } else {
            $('#modal-top-games-container').hide();
        }

        // Stake analysis - always show for context
        $('#stake-analysis').show();
        $('#modal-stake-actual').text(formatCurrency(anomalyData.stakes));
        $('#modal-stake-predicted').text(formatCurrency(anomalyData.stake_predicted));
        $('#modal-stake-deviation').text(formatCurrency(anomalyData.stake_deviation));
        $('#modal-stake-deviation-pct').text(anomalyData.stake_deviation_pct.toFixed(2) + '%');
        $('#modal-stake-score').text(anomalyData.anomaly_score_stake.toFixed(3));
        
        // Color code the deviation card based on whether it's flagged
        if (anomalyData.stake_flagged) {
            $('#stake-deviation-card').removeClass('bg-danger bg-warning bg-info bg-light')
                .addClass(getSeverityColor(anomalyData.stake_deviation_pct));
            $('#stake-analysis h6').html(`
                <svg class="icon icon-xs text-warning me-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                </svg>
                Stake Analysis <span class="badge bg-warning text-dark ms-2">FLAGGED</span>
            `);
        } else {
            $('#stake-deviation-card').removeClass('bg-danger bg-warning bg-info').addClass('bg-light');
            $('#stake-analysis h6').html(`
                <svg class="icon icon-xs text-muted me-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd"></path>
                </svg>
                Stake Analysis
            `);
        }

        // Payout analysis - always show for context
        $('#payout-analysis').show();
        $('#modal-payout-actual').text(formatCurrency(anomalyData.payouts));
        $('#modal-payout-predicted').text(formatCurrency(anomalyData.payout_predicted));
        $('#modal-payout-deviation').text(formatCurrency(anomalyData.payout_deviation));
        $('#modal-payout-deviation-pct').text(anomalyData.payout_deviation_pct.toFixed(2) + '%');
        $('#modal-payout-score').text(anomalyData.anomaly_score_payout.toFixed(3));
        
        // Color code the deviation card based on whether it's flagged
        if (anomalyData.payout_flagged) {
            $('#payout-deviation-card').removeClass('bg-danger bg-warning bg-info bg-light')
                .addClass(getSeverityColor(anomalyData.payout_deviation_pct));
            $('#payout-analysis h6').html(`
                <svg class="icon icon-xs text-danger me-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                </svg>
                Payout Analysis <span class="badge bg-danger ms-2">FLAGGED</span>
            `);
        } else {
            $('#payout-deviation-card').removeClass('bg-danger bg-warning bg-info').addClass('bg-light');
            $('#payout-analysis h6').html(`
                <svg class="icon icon-xs text-muted me-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd"></path>
                </svg>
                Payout Analysis
            `);
        }

        // Key metrics
        $('#modal-rtp').text(anomalyData.rtp.toFixed(2) + '%');
        $('#modal-ggr').text(formatCurrency(anomalyData.ggr));

        // Show the modal
        $('#anomalyModal').modal('show');
    });
});
</script>
{% endblock %}

{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard - Regulatory Triage{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-4">
    <div class="d-flex justify-content-between align-items-center pb-2 mb-4">
        <div>
            <h2 class="h4 fw-normal text-uppercase mb-0">Regulatory Triage Dashboard</h2>
        </div>
        
        <div class="d-flex align-items-center">
            <h6 class="text-muted me-2 mb-0">Data Filter:</h6>
            <select class="form-select form-select-sm" style="width: 150px;" id="timeFilter">
                <option value="today">Today</option>
                <option value="week" selected>This Week</option>
                <option value="month">This Month</option>
                <option value="custom">Custom Range</option>
            </select>
        </div>
        
        <div>
            <button class="btn btn-sm btn-outline-secondary me-2"><i class="fas fa-sync-alt me-1"></i> Refresh</button>
            <button class="btn btn-sm btn-outline-secondary"><i class="fas fa-download me-1"></i> Export</button>
        </div>
    </div>

    <!-- Main Chart and Stats Cards Row -->
    <div class="row">
        <div class="col-12 col-xl-8 mb-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <h5 class="card-title mb-0 fw-bold">GGR COLLECTED (MILLIONS)</h5>
                </div>
                <div class="card-body">
                    {% if sector_ggr_line_chart %}
                        {{ sector_ggr_line_chart | safe }}
                    {% else %}
                        <p class="text-center text-muted">No GGR trend data available for the selected period.</p>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-12 col-xl-4 mb-4">
            <div class="row">
                <div class="col-md-6 col-xl-12 mb-3">
                    <div class="card border-0 shadow-sm" style="background-color: #b3e5fc;">
                        <div class="card-body text-center py-3">
                            <h6 class="text-muted mb-2" style="font-size: 0.875rem;">GGR Available</h6>
                            <h2 class="fw-bold mb-0">UGX {{ total_ggr | floatformat:2 | default:'650.50' }}M</h2>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6 col-xl-12 mb-3">
                    <div class="card border-0 shadow-sm" style="background-color: #81c784;">
                        <div class="card-body text-center py-3">
                            <h6 class="text-white mb-2" style="font-size: 0.875rem;">Tax Collected</h6>
                            <h2 class="fw-bold mb-0 text-white">UGX {{ tax_collected | floatformat:2 | default:'650.50' }}M</h2>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6 col-xl-12 mb-3">
                    <div class="card border-0 shadow-sm" style="background-color: #f8bbd0;">
                        <div class="card-body text-center py-3">
                            <h6 class="text-muted mb-2" style="font-size: 0.875rem;">Penalties Due</h6>
                            <h2 class="fw-bold mb-0" style="color: #c2185b;">UGX 10.50M</h2>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6 col-xl-12 mb-3">
                    <div class="card border-0 shadow-sm" style="background-color: #ffffff; border: 1px solid #e0e0e0;">
                        <div class="card-body text-center py-3">
                            <h6 class="text-muted mb-2" style="font-size: 0.875rem;">Total Operators</h6>
                            <h2 class="fw-bold mb-0">{{ total_operators | default:'104' }}</h2>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6 col-xl-12 mb-3">
                    <div class="card border-0 shadow-sm" style="background-color: #b3e5fc;">
                        <div class="card-body text-center py-3">
                            <h6 class="text-muted mb-2" style="font-size: 0.875rem;">Total Licenses</h6>
                            <h2 class="fw-bold mb-0" style="color: #0277bd;">2,700</h2>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6 col-xl-12 mb-3">
                    <div class="card border-0 shadow-sm" style="background-color: #ffffff; border: 1px solid #e0e0e0;">
                        <div class="card-body text-center py-3">
                            <h6 class="text-muted mb-2" style="font-size: 0.875rem;">Active Inspectors</h6>
                            <h2 class="fw-bold mb-0">3</h2>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-12 col-xl-8 mb-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header border-bottom bg-white">
                    <h5 class="card-title mb-0 fw-bold">Game Type Averages (RTP & Std Dev)</h5>
                </div>
                <div class="table-responsive">
                    <table class="table align-items-center table-flush mb-0">
                        <thead class="thead-light">
                            <tr>
                                <th scope="col" class="text-start">Game Type</th> 
                                <th scope="col" class="text-end">Avg GGR</th> 
                                <th scope="col" class="text-center">Avg RTP</th> 
                                <th scope="col" class="text-center">RTP Std Dev</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for game in game_type_stats %}
                            <tr>
                                <th class="text-gray-900 text-start" scope="row">{{ game.type }}</th>
                                <td class="text-end">{{ game.avg_ggr | floatformat:2 }}M</td>
                                <td class="text-center">{{ game.avg_rtp | floatformat:2 }}%</td>
                                <td class="text-center">{{ game.rtp_std_dev | floatformat:4 }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center text-muted">No game type data available.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-12 col-xl-6 mb-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <h5 class="card-title mb-0 fw-bold">Top 5 Operators by GGR ({{ filter_period | default:'This Week' }})</h5>
                </div>
                <div class="card-body">
                    {% if top_operators_bar_chart %}
                        {{ top_operators_bar_chart | safe }}
                    {% else %}
                        <p class="text-center text-muted">No data to rank top operators.</p>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-12 col-xl-6 mb-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <h5 class="card-title mb-0 fw-bold">Bottom 5 Operators (Viability Risk)</h5>
                </div>
                <div class="card-body d-flex justify-content-center align-items-center" style="min-height: 250px;">
                    {% if bottom_operators_pie_chart %}
                        {{ bottom_operators_pie_chart | safe }}
                    {% else %}
                        <p class="text-center text-muted">Not enough operator data for viability analysis.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header border-bottom d-flex align-items-center bg-white">
                    <h2 class="fs-6 fw-bold mb-0">Operator Management (Triage Action List)</h2>
                    <span class="ms-3 badge bg-danger">{{ active_anomalies_count | default:'0' }} Active Alerts</span>
                </div>
                <div class="table-responsive">
                    <table class="table align-items-center table-flush">
                        <thead class="thead-light">
                            <tr>
                                <th class="border-bottom text-start" scope="col">Operator Code</th>
                                <th class="border-bottom text-end" scope="col">GGR ({{ filter_period | default:'This Week' }})</th>
                                <th class="border-bottom text-center" scope="col">Active Anomalies</th>
                                <th class="border-bottom text-center" scope="col">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for operator in operators_for_triage %}
                            <tr>
                                <th class="text-gray-900 text-start" scope="row">{{ operator.code }}</th>
                                <td class="fw-bold text-end">{{ operator.ggr | floatformat:2 }}M</td>
                                <td class="text-center">
                                    {% if operator.active_anomalies > 0 %}
                                        <span class="badge bg-danger">{{ operator.active_anomalies }}</span>
                                    {% else %}
                                        <span class="badge bg-success">0</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <a href="{% url 'performance_detail' operator_code=operator.code %}" class="btn btn-sm btn-primary">Investigate</a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center text-muted">No operators found for triage.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
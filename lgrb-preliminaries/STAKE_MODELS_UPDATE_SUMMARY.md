# Stake Models Update Summary

## Date: December 15, 2024

## Overview

Updated both stake forecasting and anomaly detection notebooks to address critical data quality issues discovered during payout analysis.

---

## Critical Issues Discovered

### 1. Missing stake_free_money Column

- **Problem:** Original `PrepareOperatorPerformance` only aggregated `stake_real_money`
- **Impact:**
  - 1,280 rows (8.33%) have free money stakes
  - Total free money: UGX 389,485,631 (0.019% overall)
  - **Operator-specific impact:**
    - **GAM:** 100% free money stakes (pure promotional)
    - **BLU:** 4.4% free money (UGX 265M - heavy promotions)
    - **ADV:** 3.7% free money (UGX 795K)
    - **ABE:** 1.9% free money (UGX 14.9M)
    - **Other operators:** <2% free money
- **Solution:** Updated aggregation to include both columns: `total_stake = stake_real_money + stake_free_money`

### 2. Zero-Stake Data Errors

- **Problem:** 188 operator-days with zero stake but non-zero bets (impossible scenario)
- **Breakdown:**
  - **ABE operator:** 181 days (96% of errors)
  - **Other operators:** 7 days
- **Impact:** Contaminated training data with impossible scenarios
- **Solution:** Filter out these data errors, save to `stake_data_errors.csv` for investigation

### 3. No-Activity Days Not Separated

- **Problem:** 1,017 operator-days with zero stake + zero bets (valid no-activity) mixed with active days
- **Impact:** Training models on heterogeneous data (operating vs non-operating days)
- **Solution:** Filter to active days only (stake > 0) for modeling, report no-activity separately

### 4. Outdated Model Outputs

- **Problem:** Existing models built with OLD data (before stake_free_money fix)
  - Models created: 2024-12-15 17:31-19:04
  - Data fixed: 2024-12-15 23:32
  - **Time gap:** ~6 hours
- **Impact:** All predictions and anomalies based on incorrect stake calculations
- **Solution:** Re-run notebooks after data fixes

---

## Changes Made

### A. Data Source (warehouse/tasks/prepare_operator_performance.py)

**Status:** ✅ Already updated and committed

```python
# Added stake_free_money to aggregation
operator_perf = df.groupby(['operator', 'date', 'game_category']).agg({
    'GGR': 'sum',
    'stake_real_money': 'sum',
    'stake_free_money': 'sum',  # ADDED
    'payout_base_win': 'sum',
    'no_of_bets': 'sum',
    # ...
})
operator_perf['total_stake'] = operator_perf['stake_real_money'] + operator_perf['stake_free_money']
```

**Output:** `warehouse/data/operator_performance.parquet` (14 columns, 257KB, timestamp: 2024-12-15 23:32:56)

### B. stake_forecasting_models.ipynb

**Status:** ✅ Updated (ready to run)

**Changes:**

1. **New Section 0:** Data Quality Check and Zero-Stake Filtering
   - Verifies stake_free_money column exists
   - Loads raw data and categorizes zero-stakes:
     - Active days (stake > 0): ~6,250 rows → **Use for modeling**
     - Data errors (stake=0, bets>0): 188 rows → **Remove and save to CSV**
     - No-activity (stake=0, bets=0): 1,017 rows → **Report separately**
   - Filters dataset to active days only
   - Prints comprehensive statistics

2. **Modified Section 1:** Data Loading
   - Uses filtered data from Section 0
   - Aggregates to tier-daily level from active days only
   - Confirms all records have non-zero stakes

3. **New Final Section:** Data Quality & Updates Summary
   - Documents all changes and their impact
   - Explains operator-specific free money usage
   - Lists updated file locations

**New Outputs:**

- `warehouse/data/stake_data_errors.csv` - 188 zero-stake + bets rows for investigation
- `warehouse/data/stake_predictions.parquet` - Updated predictions (will be regenerated)
- `warehouse/data/stake_model_performance.csv` - Updated performance metrics (will be regenerated)
- `warehouse/data/models/stake_model_*.pkl` - Updated models (will be regenerated)

### C. stake_anomaly_detection.ipynb

**Status:** ✅ Updated (ready to run after forecasting models)

**Changes:**

1. **New Section 0:** Data Quality Check and Zero-Stake Filtering
   - Similar to forecasting notebook
   - Verifies stake_free_money present
   - Documents filtering strategy

2. **Modified Section 1:** Data Loading
   - Loads `operator_efficiency_daily.parquet` (generated by forecasting models)
   - Filters `operator_performance.parquet` to active days
   - Verifies stake_free_money column present
   - Prints free money statistics

3. **New Final Section:** Data Quality & Updates Summary
   - Documents dependency on updated forecasting models
   - Explains expected improvements in anomaly detection
   - Lists all updated files

**New Outputs:**

- `warehouse/data/stake_anomalies.parquet` - Updated anomalies (will be regenerated)
- `warehouse/data/stake_anomalies_tier_specific.parquet` - Updated tier-specific anomalies (will be regenerated)
- `warehouse/data/models/stake_anomaly_*.pkl` - Updated models (will be regenerated)

---

## Verification Details

### GGR Formula Verification

- **Tested formulas:**
  1. Simple: `stake - payout` → UGX 429,871,458,316 (off by 175M)
  2. Full: `(stake_real + stake_free) - payout - refund - adjustment` → UGX 429,696,744,472 (EXACT MATCH!)
  3. Operator GGR: UGX 429,696,744,472

- **Conclusion:** Operator's GGR is comprehensive and correct
- **Components:**
  - Refunds: UGX 174,713,844
  - Adjustments: UGX 28,470

### Zero-Stake Statistics

```bash
Total operator-day records: 8,203
├── Active days (stake > 0):        6,998 (85.31%) → USE FOR MODELING
├── No-activity (stake=0, bets=0):  1,017 (12.40%) → Report separately  
└── Data errors (stake=0, bets>0):    188 (2.29%)  → Remove/investigate

Zero-stake breakdown: 1,205 total (14.69%)
```

### Free Money Impact by Operator

| Operator | Free Money % | Free Money Amount | Stakes with Free |
|----------|--------------|-------------------|------------------|
| GAM      | 100.0%       | UGX 800           | 2 days           |
| BLU      | 4.4%         | UGX 265,125,838   | 343 days         |
| ADV      | 3.7%         | UGX 795,170       | 121 days         |
| ABE      | 1.9%         | UGX 14,902,145    | 159 days         |
| BET      | 1.6%         | UGX 6,041,800     | 99 days          |
| SPO      | 0.14%        | UGX 31,006,050    | 207 days         |
| MAS      | 0.12%        | UGX 71,614,828    | 351 days         |

---

## Expected Improvements

### 1. More Accurate Predictions

- **For BLU:** 4.4% stake increase (free money now included)
- **For GAM:** Corrected from $0 to actual stake amount
- **For all operators:** No contamination from impossible zero-stake scenarios

### 2. Better Anomaly Detection

- **Fewer false positives:** 188 data errors removed from training
- **More accurate thresholds:** Based on clean data only
- **Correct context:** Free money stakes properly included in calculations

### 3. Cleaner Separation

- **Operating days vs non-operating days:** Clear distinction
- **Data errors identified:** Saved for investigation (ABE operator issue)
- **No-activity days:** Reported separately (not treated as anomalies)

### 4. Regulatory Compliance

- **Complete stake accounting:** Real + free money
- **Correct GGR verification:** Matches operator formula
- **Data quality tracking:** Errors logged for follow-up

---

## Next Steps

### Immediate (Complete Stake Model Updates)

1. ✅ **Update notebooks** - DONE
2. ⏳ **Re-run stake_forecasting_models.ipynb**
   - Execute all cells
   - Verify no errors with filtered data
   - Check model performance improvements
   - Confirm new outputs generated
3. ⏳ **Re-run stake_anomaly_detection.ipynb**
   - Execute all cells after forecasting models
   - Verify anomaly detection improvements
   - Check reduced false positive rate
   - Confirm new outputs generated
4. ⏳ **Commit updated notebooks and outputs**

### Follow-Up (Data Quality Investigation)

1. **Investigate ABE operator data errors**
   - Review `stake_data_errors.csv` (188 rows, 181 from ABE)
   - Determine root cause of zero-stake + bets scenario
   - Contact ABE operator for clarification
   - Implement data validation at ingestion

2. **Monitor free money trends**
   - Track BLU promotional campaigns (4.4% free stakes)
   - Analyze GAM business model (100% promotional)
   - Compare promotional effectiveness across operators

### Then Return to Original Goal (Payout Analysis)

1. **Build payout regression models**
   - Similar structure to stake models
   - Features: AR(lag1,lag2,lag3) + stake + bets + [win_rate for Medium tier]
   - Tier-adaptive feature sets

2. **Build payout anomaly detection**
   - Tier-specific Isolation Forest
   - Features: payout_deviation_pct + game_category_percentages
   - Risk-based contamination rates

3. **Investigate specific payout issues**
   - Negative payouts: Operator INT with -6.5B in March 2025
   - Win rate correlations: Large operators show negative correlation (-0.414 to -0.630)

---

## Files Modified

### Code

- ✅ `warehouse/tasks/prepare_operator_performance.py` (committed)
- ✅ `stake_forecasting_models.ipynb` (updated, ready to run)
- ✅ `stake_anomaly_detection.ipynb` (updated, ready to run)

### Data (Updated)

- ✅ `warehouse/data/operator_performance.parquet` (14 columns, 257KB, 2024-12-15 23:32:56)

### Data (To Be Generated)

- ⏳ `warehouse/data/stake_data_errors.csv` (188 rows)
- ⏳ `warehouse/data/stake_predictions.parquet` (updated)
- ⏳ `warehouse/data/stake_model_performance.csv` (updated)
- ⏳ `warehouse/data/stake_anomalies.parquet` (updated)
- ⏳ `warehouse/data/stake_anomalies_tier_specific.parquet` (updated)
- ⏳ `warehouse/data/models/stake_model_*.pkl` (7 tier models, updated)
- ⏳ `warehouse/data/models/stake_anomaly_*.pkl` (7 tier models, updated)

### Documentation

- ✅ `payout_eda.ipynb` (extensive investigation documentation)
- ✅ `STAKE_MODELS_UPDATE_SUMMARY.md` (this file)

---

## Success Criteria

- [x] stake_free_money included in aggregation
- [x] GGR formula verified correct
- [x] Zero-stake categorization defined and implemented
- [x] stake_forecasting_models.ipynb updated with filtering
- [x] stake_anomaly_detection.ipynb updated with filtering
- [ ] stake_forecasting_models.ipynb re-run successfully
- [ ] stake_anomaly_detection.ipynb re-run successfully
- [ ] New model outputs generated with later timestamps than source data
- [ ] Data errors investigated and resolved (ABE operator)

---

## Key Learnings

1. **Always verify all related columns:** Don't assume only one stake column exists
2. **Check aggregation completeness:** Missing 0.019% overall can be 100% for specific operators
3. **Separate data quality categories:** Zero-stakes are multiple phenomena (errors vs no-activity)
4. **Use timestamp-based validation:** File modification times reveal stale outputs
5. **Operator-level impact varies greatly:** 0.019% overall but 4.4% for BLU, 100% for GAM!
6. **Data errors need investigation:** 188 impossible rows require follow-up with operators
7. **Model invalidation is okay:** Better to catch and fix than deploy incorrect models

---

## Contact & Questions

For questions about these updates, refer to:

- **Investigation notebook:** `payout_eda.ipynb` (cells on zero-stakes and stake_free_money)
- **Updated notebooks:** `stake_forecasting_models.ipynb` and `stake_anomaly_detection.ipynb`
- **Data quality file:** `warehouse/data/stake_data_errors.csv` (after running updated notebooks)
